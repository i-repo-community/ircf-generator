<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>i‑Reporter 設定ファイル (.ircf) 生成フォーム</title>
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen">
    <div class="container mx-auto p-6 max-w-6xl min-h-screen flex flex-col">

        <!-- ヘッダーエリア -->
        <div class="space-y-6 mb-8">
            <div class="flex justify-center mb-2">
                <img src="https://community.dl-asobica.com/public/uploads/community/image_main/demo-cimtops/028d4e63-0759-4321-81ae-0d47ac22c196.png"
                    alt="ロゴ" class="max-w-full w-full sm:w-2/3 " />
            </div>
            <h1 class="text-2xl font-bold text-orange-600">アイレポ設定ファイル(.ircf) 生成くん</h1>

            <!-- 説明文書 -->
            <div class="bg-orange-50 border-l-4 border-orange-400 p-4 rounded-r-lg">
                <div class="prose text-sm text-gray-700">
                    <h2 class="text-lg font-semibold text-orange-700 mb-2">このツールについて</h2>
                    <p class="mb-2">
                        <strong>i-Reporter</strong>（アイレポーター）は、紙の帳票やExcelフォームをiPad・iPhone・Windowsで利用できる電子フォームに変換するペーパーレス化ソリューションです。
                    </p>
                    <p class="mb-3">
                        i-Reporterアプリの各システム環境設定情報を予めセットした専用の設定ファイル（<strong>.ircf</strong>）をi-Reporterアプリへ読込ませる事で、<strong>システム環境設定項目を自動でセット</strong>することができます。
                    </p>

                    <h3 class="font-semibold text-orange-600 mb-1">🎯 主な機能</h3>
                    <ul class="list-disc list-inside mb-3 space-y-1">
                        <li>サーバー接続設定（複数サーバー対応）</li>
                        <li>プロキシ・認証設定</li>
                        <li>PDF出力・メール送信設定</li>
                        <li>音声入力・署名タブレット設定</li>
                        <li><strong>既存の設定ファイル読込・編集・保存</strong></li>
                    </ul>

                    <h3 class="font-semibold text-orange-600 mb-1">📱 配布・活用メリット</h3>
                    <ul class="list-disc list-inside mb-3 space-y-1">
                        <li><strong>初期設定の簡略化</strong>：ユーザーが個別に設定する手間を削減</li>
                        <li><strong>大量端末の統一管理</strong>：システム環境設定の内容を容易に統一</li>
                        <li><strong>簡単配布</strong>：メール添付やHP公開で各ユーザーへ配布可能</li>
                        <li><strong>端末キッティング最適化</strong>：導入時の作業効率を大幅向上</li>
                    </ul>

                    <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                        <h4 class="font-semibold text-blue-700 mb-2">🔧 配布方法の例</h4>
                        <ul class="text-xs space-y-1">
                            <li>📧 <strong>メール添付</strong>：生成した.ircfファイルを添付してメール送信</li>
                            <li>🌐 <strong>HP公開</strong>：WebサイトやPortalサイトで.ircfファイルを公開</li>
                            <li>📁 <strong>共有フォルダ</strong>：社内ネットワークの共有フォルダに配置</li>
                            <li>💾 <strong>記録媒体</strong>：USBメモリやクラウドストレージ経由で配布</li>
                        </ul>
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded p-3 mb-3">
                        <h4 class="font-semibold text-green-700 mb-2">🔒 セキュリティ・プライバシー</h4>
                        <ul class="text-xs space-y-1">
                            <li>🏠 <strong>完全ローカル実行</strong>：すべての処理がブラウザ内で完結</li>
                            <li>🚫 <strong>サーバー送信なし</strong>：入力した設定データは一切外部に送信されません</li>
                            <li>📥 <strong>HTMLダウンロード可能</strong>：<a
                                    href="https://github.com/i-repo-community/ircf-generator" target="_blank"
                                    rel="noopener noreferrer"
                                    class="text-green-600 hover:text-green-800 underline">GitHubから</a>HTMLファイルをダウンロードしてオフライン利用可能
                            </li>
                            <li>✏️ <strong>カスタマイズ自由</strong>：HTMLファイルを編集して独自の初期設定項目を設定可能</li>
                            <li>🔍 <strong>オープンソース</strong>：コードが完全に公開されいます</li>
                        </ul>
                    </div>

                    <h3 class="font-semibold text-orange-600 mb-1">⚠️ 免責事項</h3>
                    <div class="text-xs bg-yellow-50 border border-yellow-200 rounded p-2 mb-3">
                        <p class="mb-1">
                            このツールは<strong>コミュニティ有志によるオープンソースソフトウェア</strong>です。
                        </p>
                        <p>
                            利用により生じたいかなる損害についても、開発者・コミュニティは一切の責任を負いません。自己責任でご利用ください。
                        </p>
                    </div>

                    <div class="bg-purple-50 border border-purple-200 rounded p-3 mb-3">
                        <h4 class="font-semibold text-purple-700 mb-2">🤝 コントリビュート歓迎！</h4>
                        <div class="text-xs space-y-1">
                            <p>このツールの改善にご協力ください：</p>
                            <ul class="list-disc list-inside ml-2 space-y-1">
                                <li><strong>機能追加・バグ修正</strong>：プルリクエストをお送りください</li>
                                <li><strong>不具合報告</strong>：GitHubのIssueでお知らせください</li>
                                <li><strong>要望・提案</strong>：新機能のアイデアをお聞かせください</li>
                                <li><strong>ドキュメント改善</strong>：説明の追加・修正も大歓迎</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mt-3 pt-3 border-t border-orange-200">
                        <p class="text-xs text-gray-600">
                            📖 <strong>.ircfファイルの詳細説明は公式ドキュメントをご覧ください：</strong><br>
                            <a href="https://cimtops-support.com/i-Reporter/ir_manuals/jp/ios_app/ConfigurationFileReading_jp.pdf"
                                target="_blank" rel="noopener noreferrer"
                                class="text-blue-600 hover:text-blue-800 underline">
                                専用設定ファイル読込によるシステム環境設定項目の自動設定機能 (PDF)
                            </a>
                        </p>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row items-center gap-4">
                <label for="loadFile"
                    class="inline-block cursor-pointer px-4 py-2 rounded bg-orange-500 text-white font-semibold hover:bg-orange-600 transition">
                    設定ファイル読込
                </label>
                <input type="file" id="loadFile" accept=".ircf,application/json" class="hidden"
                    onchange="loadSettingFile(event)">
                <span id="loadStatus" class="text-sm text-gray-500"></span>
            </div>
        </div>

        <!-- メインコンテンツエリア：レスポンシブレイアウト -->
        <div class="flex flex-col lg:flex-row gap-8 flex-1 min-h-0">
            <!-- フォームエリア -->
            <div class="flex-1 lg:w-1/2 overflow-y-auto">
                <form id="ircfForm" class="space-y-6" onsubmit="event.preventDefault(); generateJSON();">
                    <details>
                        <summary class="font-semibold">基本情報</summary>
                        <fieldset class="border rounded-lg p-4 space-y-2">
                            <label class="flex flex-col">Version
                                <input type="number" name="version" value="1" min="1" required class="mt-1 input">
                                <small class="text-gray-500">現状は1固定。機能の仕様変更時に変わります。</small>
                            </label>
                            <label class="flex flex-col">Revision
                                <input type="number" name="revision" value="1" min="1" required class="mt-1 input">
                                <small class="text-gray-500">現状は1固定。機能の仕様変更時に変わります。</small>
                            </label>
                        </fieldset>
                    </details>

                    <details>
                        <summary class="font-semibold">サーバー設定（全体）</summary>
                        <fieldset class="border rounded-lg p-4 space-y-2">
                            <label class="inline-flex items-center gap-2"><input type="checkbox" name="autoLogin"
                                    class="checkbox" checked> 自動ログイン (AutoLogin)</label>
                            <label class="inline-flex items-center gap-2"><input type="checkbox" name="canUseOffline"
                                    class="checkbox" checked> オフライン利用可 (CanUseOffline)</label>
                            <label class="flex flex-col">要求タイムアウト (TimeOut)
                                <select name="timeout" class="mt-1 select w-40">
                                    <option value="1">1 秒</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5" selected>5</option>
                                </select>
                            </label>
                            <details class="mt-2">
                                <summary class="cursor-pointer font-semibold">プロキシ設定</summary>
                                <div class="mt-2 space-y-2 ml-4">
                                    <label class="inline-flex items-center gap-2"><input type="checkbox" name="useProxy"
                                            class="checkbox"> プロキシを使用する (UseProxyIsChecked)</label>
                                    <small class="text-gray-500">Windows版にのみ適用される項目です。</small>
                                    <label class="flex flex-col">プロキシIPアドレス
                                        <input type="text" name="proxyIp" value="111.222.333.444" class="mt-1 input">
                                    </label>
                                    <small class="text-gray-500">Windows版にのみ適用される項目です。</small>
                                    <label class="flex flex-col">Proxy Port
                                        <input type="number" name="proxyPort" value="555" class="mt-1 input">
                                    </label>
                                    <small class="text-gray-500">Windows版にのみ適用される項目です。</small>
                                    <label class="flex flex-col">Proxy User
                                        <input type="text" name="proxyUser" value="proxyuser" class="mt-1 input">
                                    </label>
                                    <small class="text-gray-500">Windows版にのみ適用される項目です。</small>
                                    <label class="flex flex-col">Proxy Pass
                                        <input type="password" name="proxyPass" value="proxypass" class="mt-1 input">
                                    </label>
                                    <small class="text-gray-500">Windows版にのみ適用される項目です。</small>
                                    <label class="inline-flex items-center gap-2"><input type="checkbox"
                                            name="support100" class="checkbox" checked> 100‑Continue をサポート
                                        (Support100Continue)</label>
                                    <label class="inline-flex items-center gap-2"><input type="checkbox"
                                            name="useAdAuth" class="checkbox"> AD 認証を使用 (UseAdAuthentication)</label>
                                    <small class="text-gray-500">Windows版にのみ適用される項目です。</small>
                                </div>
                            </details>
                        </fieldset>
                    </details>

                    <fieldset class="border rounded-lg p-4" id="serversContainer">
                        <legend class="font-semibold">接続先設定（複数可）</legend>
                        <small
                            class="text-gray-500">取り込み時に1個以上あった場合、既存設定を全上書きし、一つ目の接続先を選択し、ローカルデータを全削除しますので注意してください。</small>
                    </fieldset>
                    <button type="button" onclick="addServer()" class="btn">＋接続先を追加</button>

                    <details>
                        <summary class="font-semibold">メール設定</summary>
                        <fieldset class="border rounded-lg p-4 space-y-2">
                            <label class="inline-flex items-center gap-2"><input type="checkbox" name="sendMailPDF"
                                    class="checkbox" checked> PDF をメール送信 (SendMailPDF)</label>
                            <small class="text-gray-500">※iOSのみ</small>
                            <label class="inline-flex items-center gap-2"><input type="checkbox" name="sendCrashReport"
                                    class="checkbox" checked> クラッシュレポート送信 (SendCrashReport)</label>
                            <small class="text-gray-500">※iOSのみ</small>
                            <label class="inline-flex items-center gap-2"><input type="checkbox"
                                    name="generatePDFVector" class="checkbox" checked> ベクター PDF 生成
                                (GeneratePDFWithVector)</label>
                            <small class="text-gray-500">※iOSのみ</small>
                        </fieldset>
                    </details>

                    <details>
                        <summary class="font-semibold">クラスター設定</summary>
                        <fieldset class="border rounded-lg p-4 space-y-2">
                            <label class="inline-flex items-center gap-2"><input type="checkbox"
                                    name="selectedClusterFrame" class="checkbox"
                                    checked>選択クラスターの枠表示SelectedClusterFrame</label>
                            <small class="text-gray-500">※iOSのみ</small>
                            <label class="flex flex-col">GPS フィルター距離 (GpsDistanceFilter)
                                <input type="number" name="gpsDistanceFilter" value="100" min="0"
                                    class="mt-1 input w-40">
                                <small class="text-gray-500">※iOSのみ 10, 100, 1000のみ有効</small>
                            </label>
                        </fieldset>
                    </details>

                    <details>
                        <summary class="font-semibold">PDF 出力</summary>
                        <fieldset class="border rounded-lg p-4 space-y-2">
                            <label class="flex flex-col">PDF フォント (PdfOutputFont)
                                <input type="text" name="pdfFont" value="Font Name" class="mt-1 input">
                            </label>
                            <small class="text-gray-500">※Windowsのみ</small>
                        </fieldset>
                    </details>

                    <details>
                        <summary class="font-semibold">計算チェック</summary>
                        <fieldset class="border rounded-lg p-4 space-y-2">
                            <label class="inline-flex items-center gap-2"><input type="checkbox" name="calculateCheck"
                                    class="checkbox"> 計算結果チェック機能を使用する (CalculateCheck)</label>
                            <small class="text-gray-500">※Windowsのみ</small>
                        </fieldset>
                    </details>

                    <details>
                        <summary class="font-semibold">音声入力</summary>
                        <fieldset class="border rounded-lg p-4 space-y-2">
                            <label class="inline-flex items-center gap-2"><input type="checkbox" name="usingVoiceInput"
                                    class="checkbox" checked> 音声入力を使用 (UsingVoiceInput)</label>
                            <label class="inline-flex items-center gap-2"><input type="checkbox"
                                    name="permissionVoiceInput" class="checkbox" checked> 返信時も音声入力許可
                                (PermissionVoiceInputWhileAnswerBack)</label>
                            <label class="flex flex-col">声の高さ (UtterancePitch)
                                <input type="number" step="0.1" name="utterancePitch" value="1.0" min="0.0" max="1.0"
                                    class="mt-1 input w-40">
                            </label>
                            <label class="flex flex-col">声の早さ (UtteranceRate)
                                <input type="number" step="0.1" name="utteranceRate" value="1.0" min="0.0" max="1.0"
                                    class="mt-1 input w-40">
                            </label>
                            <label class="inline-flex items-center gap-2"><input type="checkbox" name="outputSpeaker"
                                    class="checkbox" checked> スピーカー出力 (OutputSpeaker)</label>
                            <small class="text-gray-500">※iOSのみ</small>
                        </fieldset>
                    </details>
                    <details>
                        <summary class="font-semibold">一般設定</summary>
                        <fieldset class="border rounded-lg p-4 space-y-2">
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="showTest" class="checkbox" checked>
                                テスト帳票を表示 (ShowTest)
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="continueAfterSave" class="checkbox" checked>
                                サーバー保存後、編集を継続する (ContinueAfterSave)
                                <small class="text-gray-500 ml-2">※iOSのみ</small>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="definitionSave" class="checkbox" checked>
                                帳票定義保存 (DefinitionSave)
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="confirmSaveCompleted" class="checkbox" checked>
                                完了保存時に確認する (ConfirmSaveCompleted)
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="autoBackup" class="checkbox" checked>
                                自動バックアップ機能を使う (AutoBackup)
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="showConfirmUploadDialog" class="checkbox" checked>
                                アップロード確認ダイアログを表示 (ShowConfirmUploadDialog)
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="continuousNewReport" class="checkbox" checked>
                                連続帳票機能を使う (ContinuousNewReport)
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="launchKeepingWidth" class="checkbox" checked>
                                横幅ロックで起動する (LaunchKeepingWidth)
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="confirmBulkUpload" class="checkbox" checked>
                                一括アップロード時に確認メッセージを表示する (ConfirmBulkUpload)

                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="initialLibrary" class="checkbox" checked>
                                ライブラリ初期表示 (InitialLibrary)<small class="text-gray-500 ml-2">true:ローカル false:サーバー</small>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="showSentReports" class="checkbox" checked>
                                送信済ローカル保管帳票の表示 (ShowSentReports)
                                <small class="text-gray-500 ml-2">※iOSのみ</small>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="showClusterFrame" class="checkbox" checked>
                                帳票初期表示 クラスター枠 (ShowClusterFrame)
                                <small class="text-gray-500 ml-2">※iOSのみ</small>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="showNetwork" class="checkbox" checked>
                                ネットワーク線の表示 (ShowNetwork)
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="showRequiredMark" class="checkbox" checked>
                                はじめから必須入力マークを表示 (ShowRequiredMark)
                                <small class="text-gray-500 ml-2">※iOSのみ</small>
                            </label>
                            <label class="flex flex-col">
                                ローカル削除確認メッセージ表示 (ConfirmLocalDelete)
                                <input type="number" name="confirmLocalDelete" value="2" class="mt-1 input w-40">
                                <small class="text-gray-500">0:常に確認 1:一括削除時のみ 2:表示しない</small>
                            </label>
                            <label class="flex flex-col">
                                プリンタ種別 (Printer)
                                <input type="number" name="printer" value="0" class="mt-1 input w-40">
                                <small class="text-gray-500">0:プリンタなし 1:PJ-673</small>
                                <small class="text-gray-500 ml-2">※iOSのみ</small>
                            </label>
                            <label class="flex flex-col">
                                PJ-673 のIPアドレス (PJ-673Address)
                                <input type="text" name="pj673Address" value="192.168.1.1" class="mt-1 input">
                                <small class="text-gray-500">iOSのみ</small>
                            </label>
                            <label class="flex flex-col">
                                PJ-673 の印刷濃度 (PJ-673Density)
                                <input type="number" name="pj673Density" value="5" class="mt-1 input w-40">
                                <small class="text-gray-500">0〜10（iOSのみ）</small>
                            </label>
                            <label class="flex flex-col">
                                GS1-128 の区切り文字指定方法 (GS1-128Delimiter)
                                <input type="number" name="gs1Delimiter" value="0" class="mt-1 input w-40">
                                <small class="text-gray-500">0:文字 1:ASCII（iOSのみ）</small>
                            </label>
                            <label class="flex flex-col">
                                GS1-128 の区切り文字 (GS1-128Letter)
                                <input type="text" name="gs1Letter" value="," class="mt-1 input">
                                <small class="text-gray-500">iOSのみ</small>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="adobeReaderPrint" class="checkbox" checked>
                                Adobeの印刷ダイアログを使用する (AdobeReaderPrint)
                                <small class="text-gray-500 ml-2">※Windowsのみ</small>
                            </label>
                            <label class="flex flex-col">
                                タッチパネル感度 (TouchPanelSensitivity)
                                <input type="number" name="touchPanelSensitivity" value="20" class="mt-1 input w-40">
                                <small class="text-gray-500">0〜20（Windowsのみ）</small>
                            </label>
                            <label class="flex flex-col">
                                カメラロール保存先 (SaveLocalCameraImagePath)
                                <input type="text" name="saveLocalCameraPath" value="" class="mt-1 input">
                                <small class="text-gray-500">Windowsのみ</small>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="doubleClickOnActionCluster" class="checkbox" checked>
                                アクションクラスターをダブルクリックで実行する (DoubleClickOnActionCluster)
                                <small class="text-gray-500 ml-2">※Windowsのみ</small>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="continuousNewReportWithCopy" class="checkbox" checked>
                                連続帳票コピーで作成する (ContinuousNewReportWithCopy)
                                <small class="text-gray-500 ml-2">※Windowsのみ</small>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="useFullScreenSignArea" class="checkbox" checked>
                                手書きサイン領域最大表示 (UseFullScreenSignArea)
                                <small class="text-gray-500 ml-2">※Windowsのみ</small>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="allowMultiClient" class="checkbox" checked>
                                多重起動を許可する (AllowMultiClient)
                                <small class="text-gray-500 ml-2">※Windowsのみ</small>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="useSoftwareKeyboard" class="checkbox" checked>
                                ソフトウェアキーボードを使用する (UseSoftwareKeyboard)
                                <small class="text-gray-500 ml-2">※Windowsのみ</small>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="checkbox" name="moveInputClusterPosition" class="checkbox" checked>
                                クラスター編集開始時に位置補正する (MoveInputClusterPosition)
                                <small class="text-gray-500 ml-2">※Windowsのみ</small>
                            </label>
                            <label class="flex flex-col">
                                PVカメラタイプ (PvCameraType)
                                <input type="number" name="pvCameraType" value="1" class="mt-1 input w-40">
                                <small class="text-gray-500">Windowsのみ1 : 5.2.20071以前のi-Reporterカメラアプリで撮影
                                    2 : i-Reporterカメラアプリで撮影
                                    3 : Windows標準カメラで撮影
                                    Windows版にのみ適用される項目です。</small>
                            </label>
                        </fieldset>
                    </details>
                    <details>
                        <summary class="font-semibold">外部機器</summary>
                        <fieldset class="border rounded-lg p-4 space-y-2">
                            <label class="inline-flex items-center gap-2"><input type="checkbox"
                                    name="useSignatureTablet" class="checkbox" checked> 署名タブレットを使用
                                (UseSignatureTablet)</label>
                        </fieldset>
                    </details>
                    <!-- Submit -->
                    <button type="submit" class="btn-primary">JSON を生成</button>
                </form>
            </div>

            <!-- 出力エリア -->
            <div class="flex-1 lg:w-1/2 flex flex-col min-h-0">
                <div class="flex flex-col h-full">
                    <h2 class="text-xl font-semibold mb-2">生成結果</h2>
                    <textarea id="output" class="flex-1 w-full p-2 font-mono text-sm bg-gray-100 rounded resize-none"
                        readonly></textarea>
                    <div class="pt-4">
                        <a id="downloadBtn" class="hidden btn-secondary w-max"></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tailwind element macros
        document.documentElement.classList.add('dark'); // optional dark mode testing

        // ------- リアルタイム生成機能 -------
        let isGenerating = false;

        function generateJSONRealtime() {
            if (isGenerating) return;
            isGenerating = true;

            // 少し遅延を入れて連続実行を防ぐ
            setTimeout(() => {
                generateJSON();
                isGenerating = false;
            }, 100);
        }

        // フォーム要素にイベントリスナーを追加
        function setupRealtimeGeneration() {
            const form = document.getElementById('ircfForm');

            // 全ての入力要素にイベントリスナーを追加
            form.addEventListener('input', generateJSONRealtime);
            form.addEventListener('change', generateJSONRealtime);

            // 動的に追加される要素（サーバー設定）も監視
            const observer = new MutationObserver(() => {
                // 新しく追加された要素にもイベントリスナーを設定
                const newInputs = form.querySelectorAll('input, select, textarea');
                newInputs.forEach(input => {
                    if (!input.hasAttribute('data-listener-added')) {
                        input.addEventListener('input', generateJSONRealtime);
                        input.addEventListener('change', generateJSONRealtime);
                        input.setAttribute('data-listener-added', 'true');
                    }
                });
            });

            observer.observe(form, { childList: true, subtree: true });
        }

        // ページ読み込み時にセットアップ
        document.addEventListener('DOMContentLoaded', () => {
            setupRealtimeGeneration();
            // 初期生成
            generateJSON();
        });

        // ------- 設定ファイル読込機能 -------
        function loadSettingFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    fillFormFromJSON(data);
                } catch (err) {
                    console.error('ファイル読込エラー:', err);
                    document.getElementById('loadStatus').textContent = 'ファイル読込エラー';
                }
            };
            reader.readAsText(file);
        }

        function fillFormFromJSON(data) {
            const f = document.forms.ircfForm;
            console.log('読み込んだJSONデータ:', data);

            try {
                // 基本情報
                const basicMap = [
                    ["version", "Version", "value"],
                    ["revision", "Revision", "value"]
                ];
                basicMap.forEach(([formName, jsonKey, prop]) => {
                    if (f[formName] && data[jsonKey] !== undefined) {
                        f[formName][prop] = data[jsonKey];
                    }
                });

                // Server設定
                if (data.Server) {
                    const serverMap = [
                        ["autoLogin", "AutoLogin", "checked"],
                        ["canUseOffline", "CanUseOffline", "checked"],
                        ["timeout", "TimeOut", "value"],
                        ["useProxy", "UseProxyIsChecked", "checked"],
                        ["proxyIp", "ProxyIpAddress", "value"],
                        ["proxyPort", "ProxyPort", "value"],
                        ["proxyUser", "ProxyUserName", "value"],
                        ["proxyPass", "ProxyPassword", "value"],
                        ["support100", "Support100Continue", "checked"],
                        ["useAdAuth", "UseAdAuthentication", "checked"]
                    ];
                    serverMap.forEach(([formName, jsonKey, prop]) => {
                        if (f[formName] && data.Server[jsonKey] !== undefined) {
                            f[formName][prop] = data.Server[jsonKey];
                        }
                    });

                    // サーバーリストの処理
                    if (Array.isArray(data.Server.Servers)) {
                        const serverContainer = document.getElementById('serversContainer');
                        if (serverContainer) {
                            serverContainer.innerHTML = '<legend class="font-semibold">接続先設定（複数可）</legend>';
                            serverIndex = 0;
                            data.Server.Servers.forEach(s => {
                                addServer(s);
                            });
                        }
                    }
                }

                // Mail設定
                if (data.Mail) {
                    const mailMap = [
                        ["sendMailPDF", "SendMailPDF", "checked"],
                        ["sendCrashReport", "SendCrashReport", "checked"],
                        ["generatePDFVector", "GeneratePDFWithVector", "checked"]
                    ];
                    mailMap.forEach(([formName, jsonKey, prop]) => {
                        if (f[formName] && data.Mail[jsonKey] !== undefined) {
                            f[formName][prop] = data.Mail[jsonKey];
                        }
                    });
                }

                // Clusters設定
                if (data.Clusters) {
                    const clustersMap = [
                        ["selectedClusterFrame", "SelectedClusterFrame", "checked"],
                        ["gpsDistanceFilter", "GpsDistanceFilter", "value"]
                    ];
                    clustersMap.forEach(([formName, jsonKey, prop]) => {
                        if (f[formName] && data.Clusters[jsonKey] !== undefined) {
                            f[formName][prop] = data.Clusters[jsonKey];
                        }
                    });
                }

                // PDF設定
                if (data.Pdf && f.pdfFont && data.Pdf.PdfOutputFont !== undefined) {
                    f.pdfFont.value = data.Pdf.PdfOutputFont;
                }

                // CalculateCheck設定
                if (data.CalculateCheck && f.calculateCheck && data.CalculateCheck.CalculateCheck !== undefined) {
                    f.calculateCheck.checked = data.CalculateCheck.CalculateCheck;
                }

                // UsingVoiceInput設定
                if (data.UsingVoiceInput) {
                    const voiceMap = [
                        ["usingVoiceInput", "UsingVoiceInput", "checked"],
                        ["permissionVoiceInput", "PermissionVoiceInputWhileAnswerBack", "checked"],
                        ["utterancePitch", "UtterancePitch", "value"],
                        ["utteranceRate", "UtteranceRate", "value"],
                        ["outputSpeaker", "OutputSpeaker", "checked"]
                    ];
                    voiceMap.forEach(([formName, jsonKey, prop]) => {
                        if (f[formName] && data.UsingVoiceInput[jsonKey] !== undefined) {
                            f[formName][prop] = data.UsingVoiceInput[jsonKey];
                        }
                    });
                }

                // General設定
                if (data.General) {
                    const generalMap = [
                        ["pj673Address", "PJ 673Address", "value"],
                        ["pj673Density", "PJ 673Density", "value"],
                        ["gs1Delimiter", "GS1 128Delimiter", "value"],
                        ["gs1Letter", "GS1 128Letter", "value"],
                        ["showTest", "ShowTest", "checked"],
                        ["continueAfterSave", "ContinueAfterSave", "checked"],
                        ["definitionSave", "DefinitionSave", "checked"],
                        ["confirmSaveCompleted", "ConfirmSaveCompleted", "checked"],
                        ["autoBackup", "AutoBackup", "checked"],
                        ["showConfirmUploadDialog", "ShowConfirmUploadDialog", "checked"],
                        ["continuousNewReport", "ContinuousNewReport", "checked"],
                        ["launchKeepingWidth", "LaunchKeepingWidth", "checked"],
                        ["confirmBulkUpload", "ConfirmBulkUpload", "checked"],
                        ["initialLibrary", "InitialLibrary", "checked"],
                        ["showSentReports", "ShowSentReports", "checked"],
                        ["showClusterFrame", "ShowClusterFrame", "checked"],
                        ["showNetwork", "ShowNetwork", "checked"],
                        ["showRequiredMark", "ShowRequiredMark", "checked"],
                        ["confirmLocalDelete", "ConfirmLocalDelete", "value"],
                        ["printer", "Printer", "value"],
                        ["adobeReaderPrint", "AdobeReaderPrint", "checked"],
                        ["touchPanelSensitivity", "TouchPanelSensitivity", "value"],
                        ["saveLocalCameraPath", "SaveLocalCameraImagePath", "value"],
                        ["doubleClickOnActionCluster", "DoubleClickOnActionCluster", "checked"],
                        ["continuousNewReportWithCopy", "ContinuousNewReportWithCopy", "checked"],
                        ["useFullScreenSignArea", "UseFullScreenSignArea", "checked"],
                        ["allowMultiClient", "AllowMultiClient", "checked"],
                        ["useSoftwareKeyboard", "UseSoftwareKeyboard", "checked"],
                        ["moveInputClusterPosition", "MoveInputClusterPosition", "checked"],
                        ["pvCameraType", "PvCameraType", "value"]
                    ];
                    generalMap.forEach(([formName, jsonKey, prop]) => {
                        if (f[formName] && data.General[jsonKey] !== undefined) {
                            f[formName][prop] = data.General[jsonKey];
                        }
                    });
                }

                // ExternalDevice設定
                if (data.ExternalDevice && data.ExternalDevice.SignatureTablet) {
                    if (f.useSignatureTablet && data.ExternalDevice.SignatureTablet.UseSignatureTablet !== undefined) {
                        f.useSignatureTablet.checked = data.ExternalDevice.SignatureTablet.UseSignatureTablet;
                    }
                }

                // 安全のため、すべてのdetailsを閉じる
                document.querySelectorAll('details').forEach(d => d.open = false);

                // 読込後にリアルタイム生成を実行
                generateJSONRealtime();
                document.getElementById('loadStatus').textContent = '設定ファイルを読み込みました';

            } catch (error) {
                console.error('設定ファイル読み込み中にエラーが発生:', error);
                document.getElementById('loadStatus').textContent = '設定の適用中にエラーが発生しました';
            }
        }

        // ------- 接続先ブロックを動的追加 -------
        let serverIndex = 0;
        function addServer(initial = {}) {
            const c = document.getElementById('serversContainer');
            const div = document.createElement('div');
            div.className = 'border rounded-lg p-4 space-y-2 mt-4';
            div.dataset.index = serverIndex;
            div.innerHTML = `
        <h3 class="font-semibold">接続先 #${serverIndex + 1}</h3>
        <label class="flex flex-col">接続先名
          <input type="text" name="serverName${serverIndex}" value="${initial.ServerName || ''}" class="mt-1 input" required>
        </label>
        <label class="flex flex-col">URL
          <input type="url" name="url${serverIndex}" value="${initial.URL || ''}" class="mt-1 input" required>
        </label>
        <label class="flex flex-col">ユーザーID
          <input type="text" name="userId${serverIndex}" value="${initial.UserID || ''}" class="mt-1 input">
        </label>
        <label class="flex flex-col">パスワード
          <input type="password" name="password${serverIndex}" value="${initial.Password || ''}" class="mt-1 input">
        </label>
        <label class="inline-flex items-center gap-2"><input type="checkbox" name="canChange${serverIndex}" ${initial.CanChangeWithLocalReports ? 'checked' : ''} class="checkbox"> ローカル帳票存在時に接続先変更可能</label>
        <button type="button" onclick="removeServer(this)" class="btn-danger mt-2">削除</button>`;
            c.appendChild(div);

            // 新しく追加された要素にリアルタイム生成のイベントリスナーを追加
            const inputs = div.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', generateJSONRealtime);
                input.addEventListener('change', generateJSONRealtime);
                input.setAttribute('data-listener-added', 'true');
            });

            serverIndex++;
            // 追加した削除ボタンにもTailwindクラスを付与
            const btn = div.querySelector('.btn-danger');
            if (btn) btn.classList.add('px-3', 'py-1', 'rounded', 'bg-red-500', 'text-white', 'hover:bg-red-600');

            // リアルタイム生成を実行
            generateJSONRealtime();
        }

        // サーバー削除関数
        function removeServer(button) {
            button.parentElement.remove();
            generateJSONRealtime();
        }

        // サンプル初期接続先
        addServer({
            ServerName: 'CIMTOPS',
            URL: 'https://ircl-sup001kcy.conmas-i-reporter.com/ConMasWebTEST/Rests/ConMasIReporter.aspx',
            UserID: 'user01',
            Password: 'p01',
            CanChangeWithLocalReports: true
        });
        addServer({
            ServerName: 'CIMTOPS2',
            URL: 'https://ircl-sup001kcy.conmas-i-reporter.com/ConMasWebTEST2/Rests/ConMasIReporter.aspx',
            UserID: 'user02',
            Password: 'p02',
            CanChangeWithLocalReports: true
        });

        // ------- JSON 生成 -------
        function generateJSON() {
            const f = document.forms.ircfForm;
            const j = {
                Version: f.version ? Number(f.version.value) : 1,
                Revision: f.revision ? Number(f.revision.value) : 1,
                Server: {
                    AutoLogin: f.autoLogin ? f.autoLogin.checked : false,
                    CanUseOffline: f.canUseOffline ? f.canUseOffline.checked : false,
                    TimeOut: f.timeout ? Number(f.timeout.value) : 5,
                    UseProxyIsChecked: f.useProxy ? f.useProxy.checked : false,
                    ProxyIpAddress: f.proxyIp ? f.proxyIp.value : '',
                    ProxyPort: f.proxyPort ? String(f.proxyPort.value) : '',
                    ProxyUserName: f.proxyUser ? f.proxyUser.value : '',
                    ProxyPassword: f.proxyPass ? f.proxyPass.value : '',
                    Support100Continue: f.support100 ? f.support100.checked : false,
                    UseAdAuthentication: f.useAdAuth ? f.useAdAuth.checked : false,
                    Servers: []
                },
                Mail: {
                    SendMailPDF: f.sendMailPDF ? f.sendMailPDF.checked : false,
                    SendCrashReport: f.sendCrashReport ? f.sendCrashReport.checked : false,
                    GeneratePDFWithVector: f.generatePDFVector ? f.generatePDFVector.checked : false
                },
                Clusters: {
                    SelectedClusterFrame: f.selectedClusterFrame ? f.selectedClusterFrame.checked : false,
                    GpsDistanceFilter: f.gpsDistanceFilter ? Number(f.gpsDistanceFilter.value) : 0
                },
                Pdf: {
                    PdfOutputFont: f.pdfFont ? f.pdfFont.value : ''
                },
                CalculateCheck: {
                    CalculateCheck: f.calculateCheck ? f.calculateCheck.checked : false
                },
                UsingVoiceInput: {
                    UsingVoiceInput: f.usingVoiceInput ? f.usingVoiceInput.checked : false,
                    PermissionVoiceInputWhileAnswerBack: f.permissionVoiceInput ? f.permissionVoiceInput.checked : false,
                    UtterancePitch: f.utterancePitch ? Number(f.utterancePitch.value) : 1,
                    UtteranceRate: f.utteranceRate ? Number(f.utteranceRate.value) : 1,
                    OutputSpeaker: f.outputSpeaker ? f.outputSpeaker.checked : false
                },
                General: {
                    ShowTest: f.showTest ? f.showTest.checked : false,
                    ContinueAfterSave: f.continueAfterSave ? f.continueAfterSave.checked : false,
                    DefinitionSave: f.definitionSave ? f.definitionSave.checked : false,
                    ConfirmSaveCompleted: f.confirmSaveCompleted ? f.confirmSaveCompleted.checked : false,
                    AutoBackup: f.autoBackup ? f.autoBackup.checked : false,
                    ShowConfirmUploadDialog: f.showConfirmUploadDialog ? f.showConfirmUploadDialog.checked : false,
                    ContinuousNewReport: f.continuousNewReport ? f.continuousNewReport.checked : false,
                    LaunchKeepingWidth: f.launchKeepingWidth ? f.launchKeepingWidth.checked : false,
                    ConfirmBulkUpload: f.confirmBulkUpload ? f.confirmBulkUpload.checked : false,
                    InitialLibrary: f.initialLibrary ? f.initialLibrary.checked : false,
                    ShowSentReports: f.showSentReports ? f.showSentReports.checked : false,
                    ShowClusterFrame: f.showClusterFrame ? f.showClusterFrame.checked : false,
                    ShowNetwork: f.showNetwork ? f.showNetwork.checked : false,
                    ShowRequiredMark: f.showRequiredMark ? f.showRequiredMark.checked : false,
                    ConfirmLocalDelete: f.confirmLocalDelete ? Number(f.confirmLocalDelete.value) : 0,
                    Printer: f.printer ? Number(f.printer.value) : 0,
                    "PJ 673Address": f.pj673Address ? f.pj673Address.value : '',
                    "PJ 673Density": f.pj673Density ? Number(f.pj673Density.value) : 0,
                    "GS1 128Delimiter": f.gs1Delimiter ? Number(f.gs1Delimiter.value) : 0,
                    "GS1 128Letter": f.gs1Letter ? f.gs1Letter.value : '',
                    AdobeReaderPrint: f.adobeReaderPrint ? f.adobeReaderPrint.checked : false,
                    TouchPanelSensitivity: f.touchPanelSensitivity ? Number(f.touchPanelSensitivity.value) : 0,
                    SaveLocalCameraImagePath: f.saveLocalCameraPath ? f.saveLocalCameraPath.value : '',
                    DoubleClickOnActionCluster: f.doubleClickOnActionCluster ? f.doubleClickOnActionCluster.checked : false,
                    ContinuousNewReportWithCopy: f.continuousNewReportWithCopy ? f.continuousNewReportWithCopy.checked : false,
                    UseFullScreenSignArea: f.useFullScreenSignArea ? f.useFullScreenSignArea.checked : false,
                    AllowMultiClient: f.allowMultiClient ? f.allowMultiClient.checked : false,
                    UseSoftwareKeyboard: f.useSoftwareKeyboard ? f.useSoftwareKeyboard.checked : false,
                    MoveInputClusterPosition: f.moveInputClusterPosition ? f.moveInputClusterPosition.checked : false,
                    PvCameraType: f.pvCameraType ? Number(f.pvCameraType.value) : 0
                },
                ExternalDevice: {
                    SignatureTablet: {
                        UseSignatureTablet: f.useSignatureTablet ? f.useSignatureTablet.checked : false
                    }
                }
            };

            // servers loop
            document.querySelectorAll('#serversContainer [data-index]').forEach(div => {
                const i = div.dataset.index;
                j.Server.Servers.push({
                    ServerName: f[`serverName${i}`] ? f[`serverName${i}`].value : '',
                    URL: f[`url${i}`] ? f[`url${i}`].value : '',
                    UserID: f[`userId${i}`] ? f[`userId${i}`].value : '',
                    Password: f[`password${i}`] ? f[`password${i}`].value : '',
                    CanChangeWithLocalReports: f[`canChange${i}`] ? f[`canChange${i}`].checked : false
                });
            });

            // サーバーチェック
            if (j.Server.Servers.length < 1) {
                alert('1個以上あった場合、既存設定を全上書きし、一つ目の接続先を選択し、ローカルデータを全削除しますので注意してください。');
                //return;
            }

            const txt = JSON.stringify(j, null, 2);
            const out = document.getElementById('output');
            out.value = txt;

            // download
            const blob = new Blob([txt], { type: 'application/x-ircf;charset=utf-8' });
            const href = URL.createObjectURL(blob);
            const dl = document.getElementById('downloadBtn');
            dl.classList.remove('hidden');
            dl.href = href;
            dl.download = 'SettingFile.ircf';
            dl.textContent = '.ircf をダウンロード';
        }

        // Tailwind style shortcuts
        document.querySelectorAll('.btn').forEach(btn => btn.classList.add('mt-2', 'px-4', 'py-2', 'rounded', 'bg-orange-500', 'text-white', 'hover:bg-orange-600'));
        document.querySelectorAll('.btn-primary').forEach(btn => btn.classList.add('mt-4', 'px-6', 'py-2', 'rounded', 'bg-orange-600', 'text-white', 'hover:bg-orange-700'));
        document.querySelectorAll('.btn-secondary').forEach(btn => btn.classList.add('px-4', 'py-2', 'rounded', 'bg-orange-400', 'text-white', 'hover:bg-orange-500'));
        document.querySelectorAll('.btn-danger').forEach(btn => btn.classList.add('px-3', 'py-1', 'rounded', 'bg-red-500', 'text-white', 'hover:bg-red-600'));
        document.querySelectorAll('input:not([type=checkbox]):not([type=radio]), select').forEach(el => el.classList.add('border', 'rounded', 'p-1', 'focus:outline-none', 'focus:ring', 'focus:border-orange-500'));
        document.body.classList.add('bg-orange-50');
    </script>
</body>

</html>
